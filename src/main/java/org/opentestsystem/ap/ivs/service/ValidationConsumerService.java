package org.opentestsystem.ap.ivs.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.file.Path;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.eclipse.jgit.api.errors.RefNotAdvertisedException;
import org.eclipse.jgit.api.errors.RefNotFoundException;
import org.opentestsystem.ap.common.exception.SystemException;
import org.opentestsystem.ap.common.model.ItemBankSystemUser;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.opentestsystem.ap.ivs.config.IvsProperties;
import org.opentestsystem.ap.ivs.models.PushValidation;
import org.springframework.stereotype.Component;

/**
 * Pulls validation requests from the message broker.
 */
@Slf4j
@Component
public class ValidationConsumerService {

    private final ItemRepository itemRepository;

    private final IvsProperties ivsProperties;

    private final ItemBankSystemUser itemBankUser;

    public ValidationConsumerService(final ItemRepository itemRepository,
                                     final IvsProperties ivsProperties) {
        this.itemRepository = itemRepository;
        this.ivsProperties = ivsProperties;
        this.itemBankUser = new ItemBankSystemUser(
            ivsProperties.getSystemUserName(), ivsProperties.getSystemFullName());
    }

    /**
     * Validates the item and saves the results.
     *
     * @param request The validation request for a item push event.
     */
    public void validateItemPush(final PushValidation request) {
        final String itemId = request.getItemId();
        final String branchName = request.getBranchName();

        Path localRepositoryPath = null;
        try {
            localRepositoryPath = itemRepository.cloneBranch(itemBankUser, itemId, branchName);

            log.debug("validateItemPush: item {} for branch {} - cloned to {}",
                itemId, branchName, (localRepositoryPath != null) ? localRepositoryPath.toString() : "null");

            runValidation(itemId, localRepositoryPath);

            final String commitMessage = ivsProperties.getValidationCommitMessage() + request.getCommitId();

            itemRepository.saveValidationResults(itemBankUser, itemId, localRepositoryPath, branchName, commitMessage);
        } catch(SystemException e) {
            if (shouldThrowException(e)) {
                throw e;
            }
        } finally {
            deleteRepository(localRepositoryPath);
        }
    }

    /**
     * Shells out and runs the Content Package Tabulator in Error-Only mode to produce a validation.json file for the
     * indicated item.
     *
     * @param itemId The ID of the item to be validated
     * @param path   The path to the folder containing the item
     */
    public void runValidation(String itemId, Path path) {
        log.debug("Starting CPT validation for {} in path {}", itemId, path);
        String command = ivsProperties.getCptExecutablePath() + " -j " + path.toString();
        BufferedReader stdInput = null;
        try {
            Process process = Runtime.getRuntime().exec(command);
            stdInput = new BufferedReader(new
                InputStreamReader(process.getInputStream()));

            String s;
            while ((s = stdInput.readLine()) != null) {
                log.debug("CPT: {}", s);
            }

            log.debug("CPT validation complete for {} in path {}", itemId, path);
        } catch (Exception ex) {
            log.debug("Unable to execute cpt against {} in path {}", itemId, path);
        } finally {
            IOUtils.closeQuietly(stdInput);
        }
    }

    // ------------------------------------------------------------------------

    private boolean shouldThrowException(final SystemException e) {
        final Throwable rootCause = ExceptionUtils.getRootCause(e);
        if ((rootCause instanceof RefNotAdvertisedException) || (rootCause instanceof RefNotFoundException)){
            log.debug("shouldThrowException: false | message {}", rootCause.getMessage());
            return false;
        }
        return true;
    }

    private void deleteRepository(final Path path) {
        if (path != null) {
            try {
                FileUtils.deleteDirectory(path.getParent().toFile());
            } catch (IOException e) {
                log.warn("Error deleting local repository {}", path.toString(), e);
            }
        }
    }
}
