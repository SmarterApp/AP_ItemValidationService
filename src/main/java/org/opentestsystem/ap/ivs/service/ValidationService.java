package org.opentestsystem.ap.ivs.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.file.Path;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.IOUtils;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.exception.SystemException;
import org.opentestsystem.ap.common.model.ItemBankUser;
import org.opentestsystem.ap.common.model.ValidationResults;
import org.opentestsystem.ap.common.repository.ItemCrudRequest;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.opentestsystem.ap.common.util.SecurityUtil;
import org.opentestsystem.ap.ivs.config.IvsProperties;
import org.springframework.stereotype.Component;

import static org.apache.commons.collections4.ListUtils.emptyIfNull;

/**
 * Pulls validation requests from the message broker.
 */
@Slf4j
@Component
public class ValidationService {

    private final ItemRepository itemRepository;

    private final IvsProperties ivsProperties;

    private final SecurityUtil securityUtil;

    public ValidationService(final ItemRepository itemRepository,
                             final IvsProperties ivsProperties,
                             final SecurityUtil securityUtil) {
        this.itemRepository = itemRepository;
        this.ivsProperties = ivsProperties;
        this.securityUtil = securityUtil;
    }

    // ------------------------------------------------------------------------

    /**
     * Validates an item.
     *
     * @param itemId The item to validate.
     */
    public ValidationResults validateItem(final String itemId) {
        log.debug("validateItem: item {}", itemId);

        final ValidationResults result = new ValidationResults();

        GitClient gitClient = null;

        try {
            gitClient = cloneItem(itemId);
            runValidation(itemId, gitClient.getLocalRepositoryPath());
            result.setValidationResults(emptyIfNull(gitClient.readValidationFile()));
        } finally {
            close(gitClient);
        }

        return result;
    }

    // ------------------------------------------------------------------------

    /**
     * Clone a specific item branch to the local file system .
     *
     * @param itemId The unique item identifier.
     * @return The path to the local repository.
     */
    private GitClient cloneItem(final String itemId) {
        log.debug("cloneItem: item {}", itemId);

        final ItemBankUser user = securityUtil.getItemBankUser();

        final ItemCrudRequest request = itemRepository.buildLookupRequest(user, itemId, null);

        request.checkResourceNotFound();

        final GitClient git = itemRepository.cloneRemoteRepository(user, itemId);
        itemRepository.pullBranch(git, request);
        return git;
    }

    /**
     * Shells out and runs the Content Package Tabulator in Error-Only mode to produce a validation.json file for the
     * indicated item.
     *
     * @param itemId The ID of the item to be validated
     * @param path   The path to the folder containing the item
     */
    private void runValidation(String itemId, Path path) {
        log.debug("runValidation: CPT validation for {} in path {}", itemId, path);

        final String command = ivsProperties.getCptExecutablePath() + " -j " + path.toString();

        BufferedReader stdInput = null;
        try {
            final Process process = Runtime.getRuntime().exec(command);
            logValidationOutput(process);
        } catch (SystemException e) {
            throw e;
        } catch (Exception e) {
            throw new SystemException(e);
        } finally {
            IOUtils.closeQuietly(stdInput);
        }
    }

    private void close(GitClient gitClient) {
        if (gitClient != null) {
            gitClient.close();
        }
    }

    private void logValidationOutput(final Process process) {
        final BufferedReader stdInput = new BufferedReader(new InputStreamReader(process.getInputStream()));
        String s;
        try {
            while ((s = stdInput.readLine()) != null) {
                log.debug("CPT: {}", s);
            }
        } catch (IOException e) {
            log.warn("logValidationOutput: Error logging validation output.", e);
        }
    }
}
