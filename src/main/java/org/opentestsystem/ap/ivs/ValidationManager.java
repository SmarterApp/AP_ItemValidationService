package org.opentestsystem.ap.ivs;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.datastore.entity.ItemEntity;
import org.opentestsystem.ap.common.datastore.entity.ItemSyncEntity;
import org.opentestsystem.ap.common.datastore.repository.ItemEntityRepository;
import org.opentestsystem.ap.common.datastore.repository.ItemSyncRepository;
import org.opentestsystem.ap.common.model.validation.ValidationResult;

import java.util.Objects;

@Slf4j
public class ValidationManager {

    private final ItemEntityRepository itemEntityRepository;

    private final ItemSyncRepository itemSyncRepository;

    public ValidationManager(ItemEntityRepository itemEntityRepository,
                             ItemSyncRepository itemSyncRepository) {
        this.itemEntityRepository = itemEntityRepository;
        this.itemSyncRepository = itemSyncRepository;
    }

    public ValidationResult generateSyncResult(String itemId) {
        ValidationResult result = null;
        ItemEntity itemEntity = this.itemEntityRepository.findLastMaster(itemId);
        if (Objects.nonNull(itemEntity)) {
            ItemSyncEntity syncEntity = this.itemSyncRepository.findByItemCommitId(itemEntity.getId());
            if (Objects.isNull(syncEntity)) {
                result = new ValidationResult();
                result.setItemId(itemId);
                result.setItemType(itemEntity.getItemJson().getType());
                result.setMessage("Not current in item bank.");
                result.setCategory("");
                result.setDetail("");
                result.setSeverity("");
            }
        }
        return result;
    }
}
